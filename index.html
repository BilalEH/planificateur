<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Planificateur Hebdomadaire — Dark/Light</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    html,body { height:100%; margin:0; }
    body { overflow:hidden; -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale; }

    /* Fixed layout (no vertical scroll) */
    .app-wrap { max-height:100vh; height:100vh; display:flex; flex-direction:column; }

    /* Slots/cards */
    .slot { min-height:56px; max-height:56px; display:flex; align-items:center; justify-content:center; }
    .slot-empty { border:1px dashed; opacity:0.9; }
    .task-card {
      transform-origin:center;
      transition: transform .18s cubic-bezier(.2,.9,.3,1), box-shadow .18s ease, opacity .12s ease;
      user-select: none;
    }
    .task-card:active { transform: scale(.995); }

    /* Drag visual */
    .drop-target.dragover { background-color: rgba(59,130,246,0.08); border-color: rgba(59,130,246,0.28); }
    .placeholder {
      height:48px; border-radius:8px; border:2px dashed rgba(99,102,241,0.5); display:flex; align-items:center; justify-content:center;
      background: linear-gradient(90deg, rgba(99,102,241,0.06), rgba(59,130,246,0.03));
    }

    /* modal animations */
    .modal-enter { transform: translateY(10px); opacity:0; }
    .modal-enter-active { transform: translateY(0); opacity:1; transition: all .22s cubic-bezier(.2,.9,.3,1); }

    /* dark mode tweaks via .dark on body */
    body.dark { background: linear-gradient(180deg,#0b1220,#071026); color: #e6eef8; }
    body.dark .card { background: rgba(10,14,22,0.6); border:1px solid rgba(255,255,255,0.04); }
    body.dark .slot-empty { border-color: rgba(255,255,255,0.04); color: #9fb0d4; }
    body.dark .task-card { background: linear-gradient(90deg, rgba(99,102,241,0.12), rgba(79,70,229,0.08)); border:1px solid rgba(99,102,241,0.12); color: #e6eef8; }

    /* responsive compacting to keep 100vh on small screens */
    @media (max-height:720px) {
      .slot { min-height:46px; max-height:46px; }
      .header-title { font-size:1rem; }
    }
  </style>
</head>
<body class="bg-white text-slate-800">

  <div class="app-wrap">

    <!-- header -->
    <header class="h-14 flex items-center justify-between px-4 md:px-8 border-b border-gray-100">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-lg bg-gradient-to-tr from-indigo-500 to-blue-400 flex items-center justify-center text-white font-bold shadow">W</div>
        <div>
          <div class="text-xs text-slate-500">Planificateur</div>
          <div class="header-title font-semibold text-lg">Semaine — Vue compacte</div>
        </div>
      </div>

      <div class="flex items-center gap-3">
        <button id="toggleTheme" class="px-2 py-1 rounded-md border text-sm">Dark</button>
        <button id="openAdd" class="px-3 py-1 rounded-md bg-indigo-600 text-white hover:bg-indigo-700 transition">+ Nouvelle tâche</button>
        <button id="managePlaces" class="px-2 py-1 rounded-md border text-sm">Espaces</button>
      </div>
    </header>

    <!-- main grid inside no-scroll area -->
    <main class="flex-1 px-4 md:px-8 py-3 overflow-hidden">
      <div id="weekGrid" class="h-full flex flex-col gap-2 overflow-hidden">
        <!-- rows generated by JS -->
      </div>
    </main>

    <footer class="h-12 flex items-center justify-center text-xs text-slate-500 border-t border-gray-100">
      Drag & drop — chaque case 1 tâche max. Si case pleine, l’app place la tâche automatiquement dans la prochaine case disponible.
    </footer>
  </div>

  <!-- Add Task Modal -->
  <div id="modal" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
    <div class="absolute inset-0 bg-black/30 backdrop-blur-sm" onclick="closeModal()"></div>
    <form id="addForm" class="relative z-50 w-full max-w-md bg-white rounded-xl shadow-lg p-5 modal-enter">
      <h3 class="text-lg font-semibold mb-3">Ajouter une tâche</h3>

      <div class="grid grid-cols-2 gap-2">
        <label class="text-xs text-slate-500">Jour
          <select id="fDay" class="mt-1 w-full border rounded px-2 py-1">
            <option>Dimanche</option><option>Lundi</option><option>Mardi</option>
            <option>Mercredi</option><option>Jeudi</option><option>Vendredi</option><option>Samedi</option>
          </select>
        </label>

        <label class="text-xs text-slate-500">Période
          <select id="fPeriod" class="mt-1 w-full border rounded px-2 py-1">
            <option value="morning">Matin</option>
            <option value="afternoon">Après-midi</option>
            <option value="evening">Soir</option>
          </select>
        </label>

        <label class="col-span-2 text-xs text-slate-500">Titre
          <input id="fTitle" class="mt-1 w-full border rounded px-2 py-1" placeholder="Ex: Cours DB / Révision..." />
        </label>

        <label class="text-xs text-slate-500">Heure début
          <input id="fStart" type="time" class="mt-1 w-full border rounded px-2 py-1" />
        </label>

        <label class="text-xs text-slate-500">Heure fin
          <input id="fEnd" type="time" class="mt-1 w-full border rounded px-2 py-1" />
        </label>

        <label class="col-span-2 text-xs text-slate-500">Espace d'étude (optionnel)
          <div class="mt-1 flex gap-2">
            <select id="fPlaceSelect" class="flex-1 border rounded px-2 py-1"></select>
            <button type="button" id="quickPlace" class="px-2 py-1 rounded border text-sm">Auto</button>
          </div>
        </label>
      </div>

      <div class="mt-4 flex justify-between items-center">
        <div class="text-xs text-slate-400">Astuce: “Auto” choisit ton lieu favori si configuré</div>
        <div class="flex gap-2">
          <button type="button" class="px-3 py-1 rounded-md" onclick="closeModal()">Annuler</button>
          <button id="saveBtn" class="px-3 py-1 rounded-md bg-indigo-600 text-white">Enregistrer</button>
        </div>
      </div>
    </form>
  </div>

  <!-- Manage Places Modal -->
  <div id="placesModal" class="fixed inset-0 z-50 hidden items-center justify-center px-4">
    <div class="absolute inset-0 bg-black/28 backdrop-blur-sm" onclick="closePlacesModal()"></div>
    <div class="relative z-50 w-full max-w-lg bg-white rounded-xl shadow-lg p-5">
      <h3 class="text-lg font-semibold mb-3">Espaces d'étude</h3>
      <div class="flex gap-2 mb-3">
        <input id="placeName" placeholder="Nom (Ex: Bibliothèque SC-1)" class="flex-1 border rounded px-2 py-1" />
        <button id="addPlaceBtn" class="px-3 py-1 rounded bg-indigo-600 text-white">Ajouter</button>
      </div>
      <div id="placesList" class="space-y-2 max-h-40 overflow-auto pr-2">
        <!-- list -->
      </div>

      <div class="mt-4 flex justify-end gap-2">
        <button class="px-3 py-1 rounded-md" onclick="closePlacesModal()">Fermer</button>
      </div>
    </div>
  </div>

  <script>
    /* ----------------- Config & storage ----------------- */
    const DAYS = ["Dimanche","Lundi","Mardi","Mercredi","Jeudi","Vendredi","Samedi"];
    const PERIODS = [{k:"morning",label:"Matin"},{k:"afternoon",label:"Après-midi"},{k:"evening",label:"Soir"}];
    const KEY_DATA = "planner_v2_data";
    const KEY_PLACES = "planner_v2_places";
    const KEY_THEME = "planner_v2_theme";

    // load or init data structure
    function initData(){
      const raw = localStorage.getItem(KEY_DATA);
      if (raw) return JSON.parse(raw);
      const base = {};
      for(const d of DAYS){ base[d] = {}; for(const p of PERIODS) base[d][p.k] = null; }
      return base;
    }
    let data = initData();

    function loadPlaces(){ try { return JSON.parse(localStorage.getItem(KEY_PLACES)) || []; } catch { return []; } }
    let places = loadPlaces();

    function saveAll(){ localStorage.setItem(KEY_DATA, JSON.stringify(data)); localStorage.setItem(KEY_PLACES, JSON.stringify(places)); }

    /* ----------------- Theme (dark/light) ----------------- */
    const themeBtn = document.getElementById('toggleTheme');
    function applyTheme(t){
      if (t === 'dark') { document.body.classList.add('dark'); themeBtn.textContent = 'Light'; themeBtn.classList.add('bg-gray-800','text-white'); }
      else { document.body.classList.remove('dark'); themeBtn.textContent = 'Dark'; themeBtn.classList.remove('bg-gray-800','text-white'); }
      localStorage.setItem(KEY_THEME, t);
    }
    themeBtn.addEventListener('click', ()=>{
      const cur = localStorage.getItem(KEY_THEME) || 'light';
      applyTheme(cur === 'light' ? 'dark' : 'light');
      render(); fillPlaceSelect();
    });
    applyTheme(localStorage.getItem(KEY_THEME) || 'light');

    /* ----------------- Render week grid ----------------- */
    const weekGrid = document.getElementById('weekGrid');

    function render(){
      weekGrid.innerHTML = '';
      for(let i=0;i<DAYS.length;i++){
        const day = DAYS[i];
        const row = document.createElement('div'); row.className = 'flex gap-3 items-stretch';
        const label = document.createElement('div');
        label.className = 'w-36 flex-shrink-0 flex items-center justify-center font-semibold text-slate-700 bg-white border border-gray-100 rounded-lg';
        if (document.body.classList.contains('dark')) { label.classList.remove('bg-white'); label.classList.add('card'); }
        label.innerHTML = `<div class="text-sm">${day}</div>`;
        row.appendChild(label);

        const cols = document.createElement('div'); cols.className = 'flex-1 grid grid-cols-3 gap-3';
        for(let pIdx=0;pIdx<PERIODS.length;pIdx++){
          const p = PERIODS[pIdx];
          const slot = document.createElement('div');
          slot.className = 'drop-target rounded-lg p-2 slot flex items-center justify-center relative transition';
          slot.dataset.day = day; slot.dataset.period = p.k;

          const content = data[day][p.k];
          if(!content){
            slot.classList.add('slot-empty'); slot.innerHTML = `<div class="text-xs text-slate-400">Vide — ${p.label}</div>`;
          } else {
            // filled: show task card with title, time, place
            slot.innerHTML = `
              <div draggable="true" class="task-card w-full bg-white border border-gray-100 rounded-lg p-2 shadow-sm flex justify-between items-start gap-2">
                <div class="flex-1">
                  <div class="text-sm font-medium text-slate-800">${escapeHtml(content.title)}</div>
                  <div class="text-xs text-slate-500">${content.start || ''} — ${content.end || ''}</div>
                  ${content.place? `<div class="text-xs mt-1 inline-block px-2 py-0.5 rounded-full text-indigo-700 bg-indigo-100">${escapeHtml(content.place)}</div>` : ''}
                </div>
                <div class="flex flex-col items-end gap-1">
                  <button class="text-xs text-rose-600 px-1" data-action="delete" data-day="${day}" data-period="${p.k}">✕</button>
                </div>
              </div>
            `;
            const card = slot.querySelector('[draggable]');
            card.addEventListener('dragstart', onDragStart);
            // set a nicer drag image
            card.addEventListener('dragstart', (e)=>{
              try{
                const crt = card.cloneNode(true);
                crt.style.position='absolute'; crt.style.top='-1000px'; crt.style.left='-1000px'; crt.style.opacity='0.95';
                document.body.appendChild(crt);
                e.dataTransfer.setDragImage(crt, 40, 20);
                setTimeout(()=>document.body.removeChild(crt), 0);
              } catch(e){}
            });
          }

          slot.addEventListener('dragover', onDragOver);
          slot.addEventListener('dragleave', onDragLeave);
          slot.addEventListener('drop', onDrop);
          cols.appendChild(slot);
        }

        row.appendChild(cols);
        weekGrid.appendChild(row);
      }

      // delete handlers
      weekGrid.querySelectorAll('[data-action="delete"]').forEach(btn=>{
        btn.addEventListener('click', ()=>{
          const d = btn.dataset.day, p = btn.dataset.period;
          data[d][p] = null; saveAll(); render();
        });
      });
    }

    function escapeHtml(s){ return String(s||'').replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":"&#39;" }[m])); }

    /* ----------------- Drag & Drop improved ----------------- */
    let dragPayload = null;

    function onDragStart(e){
      const card = e.target.closest('.task-card');
      const slot = card.closest('.drop-target');
      dragPayload = { fromDay: slot.dataset.day, fromPeriod: slot.dataset.period, item: data[slot.dataset.day][slot.dataset.period] };
      e.dataTransfer.setData('text/plain', JSON.stringify({fromDay:dragPayload.fromDay, fromPeriod:dragPayload.fromPeriod}));
      // subtle style
      card.style.opacity = '0.85';
    }

    function onDragOver(e){
      e.preventDefault();
      const slot = e.currentTarget;
      slot.classList.add('dragover');
      // if target full show placeholder in visual (replace inner)
      if(slot.querySelector('.placeholder')) return;
      const isFull = !!data[slot.dataset.day][slot.dataset.period];
      if(isFull){
        // show small placeholder to indicate trying to drop here will push to next
        const ph = document.createElement('div'); ph.className = 'placeholder text-xs text-indigo-700';
        ph.textContent = 'Plein — cherchera la prochaine place libre';
        // add placeholder overlay but don't remove existing content
        slot.appendChild(ph);
      }
    }

    function onDragLeave(e){
      const slot = e.currentTarget;
      slot.classList.remove('dragover');
      const ph = slot.querySelector('.placeholder'); if(ph) ph.remove();
    }

    function onDrop(e){
      e.preventDefault();
      const slot = e.currentTarget;
      slot.classList.remove('dragover');
      const ph = slot.querySelector('.placeholder'); if(ph) ph.remove();

      // get payload (but we'll use global)
      if(!dragPayload) return;
      const fromDay = dragPayload.fromDay, fromPeriod = dragPayload.fromPeriod;
      const taskObj = dragPayload.item;
      // remove from origin first
      data[fromDay][fromPeriod] = null;

      // attempt to place starting here
      const placed = placeInNextAvailable({day: slot.dataset.day, period: slot.dataset.period}, taskObj);
      if(!placed){
        // restore origin and shake target to indicate fail
        data[fromDay][fromPeriod] = taskObj;
        slot.animate([{transform:'translateX(-4px)'},{transform:'translateX(4px)'},{transform:'translateX(0)'}], {duration:260});
      } else {
        // nice drop animation: flash
        slot.animate([{background:'#f4fbff'},{background:''}], {duration:300});
      }
      dragPayload = null; saveAll(); render();
    }

    /* placeInNextAvailable: search forward through week for first empty slot */
    function placeInNextAvailable(start, task){
      const total = DAYS.length * PERIODS.length;
      const sD = DAYS.indexOf(start.day);
      const sP = PERIODS.findIndex(x=>x.k===start.period);
      if(sD<0||sP<0) return false;
      for(let step=0; step<total; step++){
        const lin = (sD*PERIODS.length + sP + step) % total;
        const dIdx = Math.floor(lin / PERIODS.length);
        const pIdx = lin % PERIODS.length;
        const d = DAYS[dIdx], p = PERIODS[pIdx].k;
        if(!data[d][p]){ data[d][p] = task; return true; }
      }
      return false;
    }

    /* ----------------- Modal behaviors ----------------- */
    const modal = document.getElementById('modal');
    const placesModal = document.getElementById('placesModal');

    document.getElementById('openAdd').addEventListener('click', openModal);
    document.getElementById('managePlaces').addEventListener('click', openPlacesModal);

    function openModal(){
      modal.classList.remove('hidden');
      const form = document.getElementById('addForm'); form.classList.add('modal-enter-active');
      fillPlaceSelect();
      // defaults
      document.getElementById('fTitle').value = '';
      document.getElementById('fStart').value = '';
      document.getElementById('fEnd').value = '';
      // select first day by default
      document.getElementById('fDay').value = DAYS[0];
    }
    function closeModal(){ modal.classList.add('hidden'); }

    // places modal
    function openPlacesModal(){ placesModal.classList.remove('hidden'); renderPlaces(); }
    function closePlacesModal(){ placesModal.classList.add('hidden'); }
    document.getElementById('addPlaceBtn').addEventListener('click', ()=>{
      const name = document.getElementById('placeName').value.trim();
      if(!name) return alert('Nom vide');
      places.unshift(name);
      localStorage.setItem(KEY_PLACES, JSON.stringify(places));
      document.getElementById('placeName').value = '';
      renderPlaces(); fillPlaceSelect();
    });

    function renderPlaces(){
      const list = document.getElementById('placesList'); list.innerHTML = '';
      if(places.length===0){ list.innerHTML = '<div class="text-xs text-slate-400">Aucun espace enregistré.</div>'; return; }
      places.forEach((pl,idx)=>{
        const row = document.createElement('div'); row.className='flex items-center justify-between gap-2';
        row.innerHTML = `<div class="text-sm">${escapeHtml(pl)}</div>
          <div class="flex gap-2">
            <button class="px-2 py-0.5 text-xs rounded border" data-idx="${idx}" data-action="use">Utiliser</button>
            <button class="px-2 py-0.5 text-xs rounded border text-rose-600" data-idx="${idx}" data-action="del">Suppr</button>
          </div>`;
        list.appendChild(row);
      });
      // actions
      list.querySelectorAll('[data-action="use"]').forEach(b=>{
        b.addEventListener('click', ()=> {
          const p = places[parseInt(b.dataset.idx)]; navigator.clipboard?.writeText(p).catch(()=>{}); alert('Copié: '+p);
        });
      });
      list.querySelectorAll('[data-action="del"]').forEach(b=>{
        b.addEventListener('click', ()=>{
          if(!confirm('Supprimer cet espace?')) return;
          places.splice(parseInt(b.dataset.idx),1);
          localStorage.setItem(KEY_PLACES, JSON.stringify(places));
          renderPlaces(); fillPlaceSelect();
        });
      });
    }

    function fillPlaceSelect(){
      const sel = document.getElementById('fPlaceSelect'); sel.innerHTML = '<option value="">— Aucun —</option>';
      for(const p of places){ const opt = document.createElement('option'); opt.value = p; opt.textContent = p; sel.appendChild(opt); }
    }

    // quick place: auto fill favorite (first in list)
    document.getElementById('quickPlace').addEventListener('click', ()=>{
      if(places.length===0) return alert('Aucun espace configuré. Ajoute en cliquant sur "Espaces"');
      document.getElementById('fPlaceSelect').value = places[0];
    });

    /* save new task */
    document.getElementById('saveBtn').addEventListener('click', (ev)=>{
      ev.preventDefault();
      const day = document.getElementById('fDay').value;
      const period = document.getElementById('fPeriod').value;
      const title = document.getElementById('fTitle').value.trim();
      const start = document.getElementById('fStart').value;
      const end = document.getElementById('fEnd').value;
      const place = document.getElementById('fPlaceSelect').value || '';
      if(!title) return alert('Titre requis');
      const task = { id: Math.random().toString(36).slice(2,9), title, start, end, place };

      const placed = placeInNextAvailable({day, period}, task);
      if(!placed) return alert('Aucune place libre cette semaine.');
      saveAll(); render(); closeModal();
    });

    /* ----------------- init render & theme from storage ----------------- */
    // restore theme from storage
    const storedTheme = localStorage.getItem(KEY_THEME) || 'light';
    applyTheme(storedTheme);

    // restore places from storage var already loaded
    render(); fillPlaceSelect();

    // accessibility: close modals with Esc
    window.addEventListener('keydown', (e)=>{ if(e.key==='Escape'){ closeModal(); closePlacesModal(); } });

    // small utility to keep data persistent on unload
    window.addEventListener('beforeunload', ()=> saveAll());
  </script>
</body>
</html>
